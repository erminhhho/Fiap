<form id="documents-form" autocomplete="off">
  <div class="bg-white rounded-2xl shadow p-8 mb-8">
    <div class="flex items-center justify-between gap-2 mb-6">
      <div class="flex items-center gap-2">
      <i class="fas fa-file-alt text-blue-500 text-2xl"></i>
      <h2 class="text-xl font-semibold text-blue-600">Documentos</h2>
      </div>
      <i class="fas fa-eraser cursor-pointer text-gray-400 hover:text-red-500 transition" title="Limpar seção" onclick="showClearConfirmation(event, 'documentos')"></i>
    </div>

    <!-- Lista de Documentos -->
    <div id="documentsList" class="space-y-1">
      <!-- Campo de pesquisa centralizado com design mais compacto -->
      <div class="relative mb-3 max-w-lg mx-auto">
        <input type="text" id="documento-pesquisa" class="peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 placeholder-gray-400 transition-colors duration-200 text-base" placeholder="Digite o nome do documento para pesquisar ou adicionar...">
        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400">
          <i class="fas fa-search"></i>
        </div>
      </div>

      <!-- Resultados da pesquisa (aparecerão abaixo do campo) -->
      <div id="resultados-pesquisa" class="max-w-lg mx-auto hidden">
        <!-- Essa div será preenchida via JavaScript -->
      </div>

      <!-- Lista de documentos adicionados com espaçamento reduzido -->
      <div id="documentos-container" class="space-y-1 my-3">
        <!-- Documentos adicionados serão inseridos aqui -->
      </div>
    </div>
  </div>

  <!-- Observações -->
  <div class="relative mt-6">
    <textarea id="observacoes" rows="3" class="peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 placeholder-gray-400 transition-colors duration-200 text-base" placeholder="Observações sobre os documentos..."></textarea>
    <label for="observacoes" class="input-label text-base">
      Observações
    </label>
  </div>

  <!-- Botões de navegação -->
  <div class="flex justify-between mt-6">
    <button type="button" id="btn-back" class="bg-white hover:bg-gray-100 text-blue-600 font-semibold rounded-lg px-6 py-2 text-base shadow border border-blue-200 transition focus:outline-none focus:ring-2 focus:ring-blue-100 flex items-center gap-2">
      <i class="fas fa-arrow-left"></i> Anterior
    </button>

    <button type="button" id="btn-print" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg px-6 py-2 text-base shadow transition focus:outline-none focus:ring-2 focus:ring-blue-300 flex items-center gap-2" onclick="printForm()">
      <i class="fas fa-print"></i> Imprimir
    </button>
  </div>
</form>

<!-- Template para novo documento adicionado -->
<template id="documentoTemplate">
  <div class="flex items-start gap-2 mb-3">
    <!-- Card principal do documento -->
    <div class="documento-adicionado flex-grow relative p-3 bg-white rounded-lg border border-gray-200 shadow-sm hover:border-blue-200 transition-colors" data-status="obter">
      <!-- Layout mais eficiente e compacto -->
      <div class="flex flex-wrap items-center gap-3">
        <!-- Ícone de informação e nome -->
        <div class="flex-grow flex items-center gap-2">
          <i class="fas fa-info-circle text-blue-500"></i>
          <input type="text" class="nome-documento text-base font-medium text-gray-800 bg-transparent border-b border-gray-200 focus:border-blue-600 focus:ring-0 px-1 py-0.5 w-full" placeholder="Nome do documento">
        </div>

        <!-- Campo de ano dedicado -->
        <div class="flex-shrink-0 flex items-center text-sm text-gray-600">
          <span class="text-gray-500 font-medium mr-1">Ano:</span>
          <input type="number" min="1900" max="2099" class="ano-documento bg-transparent border-b border-gray-200 focus:border-blue-500 focus:ring-0 px-1 py-0.5 w-16" placeholder="Ano">
        </div>

        <!-- Status com posicionamento correto -->
        <div class="flex-shrink-0">
          <div class="relationship-select top-auto right-auto" data-selected="Obter" data-value="Obter" onclick="toggleDocumentStatusTag(this)">
            <select class="documento-status" onchange="updateDocumentStatusTag(this)">
              <option value="Recebido">Recebido</option>
              <option value="Solicitado">Solicitado</option>
              <option value="Obter" selected>Obter</option>
            </select>
          </div>
        </div>

        <!-- Botão de remover padrão do projeto -->
        <button type="button" class="remover-documento flex-shrink-0 text-gray-400 hover:text-red-500 transition" title="Remover documento">
          <i class="fas fa-trash-alt"></i>
        </button>
      </div>

      <!-- Campo de descrição oculto (será exibido no popup) -->
      <div class="detalhes-documento-container hidden">
        <textarea class="detalhes-documento w-full" rows="2" placeholder="Detalhes adicionais sobre o documento..."></textarea>
      </div>
    </div>
  </div>
</template>

<!-- Template para o popup de informações do documento -->
<div id="documento-info-popup" class="hidden fixed z-50">
  <div class="bg-white rounded-lg shadow-lg border border-gray-200 p-4 max-w-md animate-fade-in">
    <div class="flex justify-between items-center mb-2">
      <h3 class="text-lg font-semibold text-gray-800 documento-info-titulo"></h3>
      <button type="button" class="fechar-info text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="documento-info-conteudo text-sm text-gray-600 max-h-60 overflow-y-auto"></div>
  </div>
</div>

<!-- Scripts -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (window.initModule) {
      window.initModule();
    }
  });

  // Função para alternar o status de um documento através das tags clicáveis
  function toggleDocumentStatus(button) {
    if (!button) return;

    const documentoElement = button.closest('.documento-adicionado');
    if (!documentoElement) return;

    const status = button.dataset.status;
    const allTags = documentoElement.querySelectorAll('.documento-tag');

    // Removemos as classes de status ativo de todas as tags
    allTags.forEach(tag => {
      tag.classList.remove('success', 'info', 'warning', 'active');
    });

    // Atualizar o data-status no elemento do documento
    documentoElement.dataset.status = status;

    // Atualizar a classe do botão clicado de acordo com o status
    if (status === 'recebido') {
      button.classList.add('success', 'active');
    } else if (status === 'solicitado') {
      button.classList.add('info', 'active');
    } else if (status === 'obter') {
      button.classList.add('warning', 'active');
    }

    // Adicionar classe ao documento para visualização rápida
    documentoElement.classList.remove('status-recebido', 'status-solicitado', 'status-obter');
    documentoElement.classList.add('status-' + status);

    // Salvar alterações
    if (typeof saveFormState === 'function') {
      saveFormState();
    }
  }

  // Função para alternar o status de um documento através da tag de relacionamento
  function toggleDocumentStatusTag(element) {
    // Obter o status atual
    const currentStatus = element.getAttribute('data-selected');
    const statusValue = element.getAttribute('data-value') || element.querySelector('select').value;

    // Garantir que sempre tenhamos o data-value para aplicar a cor correta
    if (!element.hasAttribute('data-value')) {
      element.setAttribute('data-value', statusValue);
    }

    // Se já tem um status selecionado, vamos deixá-lo no formato padrão
    if (currentStatus) {
      element.removeAttribute('data-selected');
    } else {
      // Caso contrário, vamos usar o valor do data-value como o status selecionado
      element.setAttribute('data-selected', statusValue);
    }

    // Atualizar o status no elemento do documento
    const documentoElement = element.closest('.documento-adicionado');
    if (documentoElement) {
      // Mapear o valor do status para o formato correto esperado pelo sistema
      let mappedStatus = statusValue.toLowerCase();

      // Corrigir o mapeamento para a convenção de nomenclatura do sistema
      if (mappedStatus === 'recebido') mappedStatus = 'recebido';
      else if (mappedStatus === 'solicitado') mappedStatus = 'solicitado';
      else if (mappedStatus === 'obter') mappedStatus = 'obter';

      // Atualizar o atributo data-status
      documentoElement.dataset.status = mappedStatus;

      // Atualizar as classes CSS para visualização rápida
      documentoElement.classList.remove('status-recebido', 'status-solicitado', 'status-obter');
      documentoElement.classList.add('status-' + mappedStatus);
    }

    // Salvar alterações
    if (typeof saveFormState === 'function') {
      saveFormState();
    }
  }

  // Função para atualizar a tag de status do documento
  function updateDocumentStatusTag(select) {
    const container = select.closest('.relationship-select');
    const value = select.value;

    // Atualiza os atributos data-selected e data-value
    container.setAttribute('data-selected', value);
    container.setAttribute('data-value', value);

    // Atualizar o status no elemento do documento
    const documentoElement = container.closest('.documento-adicionado');
    if (documentoElement) {
      // Mapear o valor do status para o formato correto esperado pelo sistema
      let mappedStatus = value.toLowerCase();

      // Corrigir o mapeamento para a convenção de nomenclatura do sistema
      if (mappedStatus === 'recebido') mappedStatus = 'recebido';
      else if (mappedStatus === 'solicitado') mappedStatus = 'solicitado';
      else if (mappedStatus === 'obter') mappedStatus = 'obter';

      // Atualizar o atributo data-status
      documentoElement.dataset.status = mappedStatus;

      // Atualizar as classes CSS para visualização rápida
      documentoElement.classList.remove('status-recebido', 'status-solicitado', 'status-obter');
      documentoElement.classList.add('status-' + mappedStatus);
    }

    // Salvar alterações
    if (typeof saveFormState === 'function') {
      saveFormState();
    }
  }

  // Função para expandir/contrair os detalhes do documento
  function toggleDocumentFields(button) {
    if (!button) return;

    const documentoElement = button.closest('.documento-adicionado');
    if (!documentoElement) return;

    const detalhesArea = documentoElement.querySelector('.detalhes-documento-container');
    const icon = button.querySelector('i');

    if (detalhesArea) {
      if (detalhesArea.classList.contains('hidden')) {
        detalhesArea.classList.remove('hidden');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
      } else {
        detalhesArea.classList.add('hidden');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
      }
    }
  }
</script>

<style>
  /* Estilos para as tags de status de documento */
  .documento-tag {
    display: inline-flex;
    align-items: center;
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.25rem 0.6rem;
    border-radius: 9999px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    background-color: rgba(243, 244, 246, 0.8);
    color: #6b7280;
    transition: all 0.2s ease;
  }

  /* Aparência quando ativa */
  .documento-tag.active {
    font-weight: 600;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  /* Status Recebido */
  .documento-tag[data-status="recebido"].active,
  .documento-tag.success.active {
    background-color: rgba(16, 185, 129, 0.1);
    color: #065f46;
    border-color: rgba(16, 185, 129, 0.3);
  }

  /* Status Solicitado */
  .documento-tag[data-status="solicitado"].active,
  .documento-tag.info.active {
    background-color: rgba(59, 130, 246, 0.1);
    color: #1e40af;
    border-color: rgba(59, 130, 246, 0.3);
  }

  /* Status Obter */
  .documento-tag[data-status="obter"].active,
  .documento-tag.warning.active {
    background-color: rgba(245, 158, 11, 0.1);
    color: #92400e;
    border-color: rgba(245, 158, 11, 0.3);
  }

  /* Efeito hover para todas as tags */
  .documento-tag:hover {
    transform: translateY(-1px);
  }

  /* Bordas coloridas para documentos com status definido */
  .documento-adicionado.status-recebido {
    border-left: 3px solid #10b981;
  }

  .documento-adicionado.status-solicitado {
    border-left: 3px solid #3b82f6;
  }

  .documento-adicionado.status-obter {
    border-left: 3px solid #f59e0b;
  }

  /* Estilos para o sistema de tags relationship-select em documentos */
  /* Cores específicas para status de documentos */
  .relationship-select[data-value="Recebido"] {
    background-color: #10b981 !important; /* Verde */
    color: white !important;
  }

  .relationship-select[data-value="Solicitado"] {
    background-color: #3b82f6 !important; /* Azul */
    color: white !important;
  }

  .relationship-select[data-value="Obter"] {
    background-color: #f59e0b !important; /* Laranja */
    color: white !important;
  }

  /* Posicionamento da etiqueta de status nos documentos */
  .documento-adicionado .relationship-select {
    position: relative;
    transform: none;
    right: auto;
    top: auto;
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    white-space: nowrap;
  }

  /* Estilos para o popup de informações */
  #documento-info-popup {
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    backdrop-filter: blur(4px);
  }

  #documento-info-popup .documento-info-conteudo {
    line-height: 1.6;
  }

  /* Animação de entrada para o popup */
  @keyframes popup-fade-in {
    from { opacity: 0; transform: translateY(10px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  #documento-info-popup .animate-fade-in {
    animation: popup-fade-in 0.25s ease-out forwards;
  }

  /* Estilo do ícone de informação e interação */
  .fa-info-circle {
    transition: transform 0.2s ease, color 0.2s ease;
  }

  .documento-adicionado .fa-info-circle:hover {
    transform: scale(1.15);
    color: #3b82f6;
  }

  /* Estilo para o campo de ano */
  .documento-adicionado .ano-documento {
    width: 4rem;
    text-align: center;
  }

  /* Botão de remover documento */
  .remover-documento {
    transition: color 0.2s ease;
    padding: 0.5rem;
    margin: -0.5rem;
  }

  .remover-documento:hover {
    color: #ef4444;
  }
</style>


