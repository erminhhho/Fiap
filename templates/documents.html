<form id="documents-form" autocomplete="off">
  <div class="bg-white rounded-2xl shadow p-8 mb-8">
    <div class="flex items-center gap-2 mb-6">
      <i class="fas fa-file-alt text-blue-500 text-2xl"></i>
      <h2 class="text-lg font-semibold text-blue-600">Documentos</h2>
    </div>

    <!-- Lista de Documentos -->
    <div id="documentsList" class="space-y-4">
      <!-- Campo de pesquisa centralizado -->
      <div class="mb-6">
        <div class="relative max-w-lg mx-auto">
          <input type="text" id="documento-pesquisa" class="peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200" placeholder="Digite para pesquisar ou adicionar um documento...">
          <label for="documento-pesquisa" class="input-label">
            Buscar/Adicionar Documento
          </label>
          <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
            <i class="fas fa-search"></i>
          </div>
        </div>

        <!-- Resultados da pesquisa e opção de novo documento -->
        <div id="resultados-pesquisa" class="mt-2 max-w-lg mx-auto hidden">
          <!-- Lista de resultados -->
          <div id="lista-resultados" class="bg-gray-50 border border-gray-200 rounded-lg overflow-hidden divide-y divide-gray-100">
            <!-- Resultados da pesquisa serão inseridos aqui -->
          </div>

          <!-- Opção para criar novo documento (aparece quando não há correspondências) -->
          <div id="opcao-novo-documento" class="mt-2">
            <button type="button" id="btn-criar-documento" class="w-full bg-blue-50 hover:bg-blue-100 text-left px-4 py-3 rounded-lg border border-blue-200 flex items-center justify-between transition">
              <span><i class="fas fa-plus-circle text-blue-500 mr-2"></i> Criar novo documento: "<span id="texto-novo-documento"></span>"</span>
              <i class="fas fa-plus text-blue-500"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Botão de adicionar documento alternativo -->
      <div class="text-center mb-6">
        <button type="button" id="btn-adicionar-documento" class="bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg px-5 py-2.5 text-sm shadow transition focus:ring-2 focus:ring-blue-300">
          <i class="fas fa-plus mr-2"></i> Adicionar Novo Documento
        </button>
      </div>

      <!-- Lista de documentos adicionados -->
      <div id="documentos-container" class="space-y-4 my-6">
        <!-- Documentos adicionados serão inseridos aqui -->
      </div>
    </div>
  </div>

  <!-- Observações -->
  <div class="relative mt-8">
    <textarea id="observacoes" rows="3" class="peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 placeholder-gray-400 transition-colors duration-200" placeholder="Observações sobre os documentos..."></textarea>
    <label for="observacoes" class="input-label">
      Observações
    </label>
  </div>

  <!-- Botões de navegação -->
  <div class="flex justify-between mt-8">
    <button type="button" id="btn-back" class="bg-white hover:bg-gray-100 text-blue-600 font-semibold rounded-lg px-8 py-3 text-base shadow border border-blue-200 transition focus:outline-none focus:ring-2 focus:ring-blue-100 flex items-center gap-2">
      <i class="fas fa-arrow-left"></i> Anterior
    </button>

    <button type="submit" id="btn-save" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg px-8 py-3 text-base shadow transition focus:outline-none focus:ring-2 focus:ring-blue-300 flex items-center gap-2">
      <i class="fas fa-save"></i> Salvar
    </button>
  </div>
</form>

<!-- Template para novo documento adicionado -->
<template id="documentoTemplate">
  <div class="documento-adicionado relative p-4 bg-gray-50 rounded-lg shadow-sm mb-4">
    <!-- Cabeçalho do documento -->
    <div class="flex flex-wrap items-center gap-4 mb-3">
      <!-- Nome do documento -->
      <div class="relative flex-grow">
        <input type="text" class="nome-documento peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200" placeholder="Nome do documento">
        <label class="input-label">
          Nome do Documento
        </label>
      </div>

      <!-- Status do documento -->
      <div class="relative w-52">
        <select class="status-documento peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200" onchange="toggleDocumentFields(this)">
          <option value="" selected disabled>Selecione...</option>
          <option value="disponivel">Disponível/Em mãos</option>
          <option value="solicitar">Solicitar do cliente</option>
          <option value="solicitado_orgao">Solicitar de órgão/empresa</option>
          <option value="nao_disponivel">Não disponível</option>
        </select>
        <label class="input-label">
          Status
        </label>
      </div>

      <!-- Ano do documento -->
      <div class="relative w-32">
        <input type="number" min="1900" max="2099" class="ano-documento peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200" placeholder="Ano">
        <label class="input-label">
          Ano
        </label>
      </div>

      <!-- Botão de remover -->
      <div class="flex items-center">
        <button type="button" class="remover-documento bg-red-500 hover:bg-red-600 text-white rounded-full p-1 flex items-center justify-center w-8 h-8" title="Remover documento">
          <i class="fas fa-minus"></i>
        </button>
      </div>
    </div>

    <!-- Campos de conteúdo do documento -->
    <div class="grid grid-cols-1 gap-4">
      <!-- Detalhes adicionais do documento - sempre visível -->
      <div class="relative document-field">
        <textarea class="detalhes-documento peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200" rows="3" placeholder="Informações adicionais, número de série, data de emissão, órgão emissor, localização física, etc."></textarea>
        <label class="input-label">
          Detalhes do documento
        </label>
      </div>

      <!-- Campos específicos para documento disponível -->
      <div class="document-status-fields disponivel-fields hidden">
        <div class="relative document-field">
          <textarea class="peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200" rows="2" placeholder="Observações sobre o documento disponível"></textarea>
          <label class="input-label">
            Considerações sobre o documento disponível
          </label>
        </div>
      </div>

      <!-- Campos específicos para solicitar do cliente -->
      <div class="document-status-fields solicitar-fields hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="relative document-field">
            <input type="date" class="peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200">
            <label class="input-label">
              Data da solicitação
            </label>
          </div>
          <div class="relative document-field">
            <input type="date" class="peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200">
            <label class="input-label">
              Prazo para entrega
            </label>
          </div>
        </div>
        <div class="relative document-field mt-4">
          <textarea class="peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200" rows="2" placeholder="Instruções específicas para o cliente sobre o documento"></textarea>
          <label class="input-label">
            Instruções para o cliente
          </label>
        </div>
      </div>

      <!-- Campos específicos para solicitar de órgão/empresa -->
      <div class="document-status-fields solicitado_orgao-fields hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="relative document-field">
            <input type="text" class="peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200" placeholder="Nome do órgão ou empresa">
            <label class="input-label">
              Órgão/Empresa
            </label>
          </div>
          <div class="relative document-field">
            <input type="text" class="peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200" placeholder="Ex: ofício, processo administrativo">
            <label class="input-label">
              Forma de solicitação
            </label>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div class="relative document-field">
            <input type="date" class="peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200">
            <label class="input-label">
              Data da solicitação
            </label>
          </div>
          <div class="relative document-field">
            <input type="text" class="peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200" placeholder="Ex: 30 dias, número de protocolo">
            <label class="input-label">
              Prazo/Protocolo
            </label>
          </div>
        </div>
      </div>

      <!-- Campos específicos para não disponível -->
      <div class="document-status-fields nao_disponivel-fields hidden">
        <div class="relative document-field">
          <textarea class="peer w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-100 px-4 py-3 text-gray-800 bg-gray-50 transition-colors duration-200" rows="2" placeholder="Motivo da indisponibilidade e possíveis alternativas"></textarea>
          <label class="input-label">
            Motivo e alternativas
          </label>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Scripts -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (window.initModule) {
      window.initModule();
    }

    // Inicializar o sistema de documentos
    initDocumentSystem();
  });

  // Inicializar sistema de documentos
  function initDocumentSystem() {
    // Elementos DOM
    const searchInput = document.getElementById('documento-pesquisa');
    const resultadosContainer = document.getElementById('resultados-pesquisa');
    const listaResultados = document.getElementById('lista-resultados');
    const opcaoNovoDocumento = document.getElementById('opcao-novo-documento');
    const textoNovoDocumento = document.getElementById('texto-novo-documento');
    const btnCriarDocumento = document.getElementById('btn-criar-documento');
    const btnAdicionarDocumento = document.getElementById('btn-adicionar-documento');

    // Lista de documentos comuns
    const documentosComuns = [
      'Carteira de Trabalho', 'Certidão de Nascimento', 'Certidão de Casamento',
      'Bloco de Notas de Produtor Rural', 'Comprovante de Residência Rural',
      'Declaração de Sindicato Rural', 'Ficha de Matrícula Escolar Rural',
      'Contratos de Arrendamento Rural', 'Cadastro de Produtor Rural',
      'Conta de Luz Rural', 'Notas Fiscais de Produtos Agrícolas',
      'Imposto Territorial Rural (ITR)', 'Histórico Escolar Rural',
      'Prontuário Médico', 'Comprovante de Recebimento de Benefício',
      'RG', 'CPF', 'Título de Eleitor'
    ];

    // Botão de adicionar documento
    btnAdicionarDocumento.addEventListener('click', function() {
      adicionarDocumento('Novo Documento');
    });

    // Botão de criar documento da pesquisa
    btnCriarDocumento.addEventListener('click', function() {
      const texto = searchInput.value.trim();
      if (texto) {
        adicionarDocumento(texto);
        searchInput.value = '';
        resultadosContainer.classList.add('hidden');
      }
    });

    // Campo de pesquisa - evento de digitação
    searchInput.addEventListener('input', function() {
      const query = this.value.trim();

      // Se vazio, ocultar resultados
      if (!query) {
        resultadosContainer.classList.add('hidden');
        return;
      }

      // Mostrar container de resultados
      resultadosContainer.classList.remove('hidden');

      // Limpar resultados anteriores
      listaResultados.innerHTML = '';

      // Filtrar documentos que correspondam à consulta
      const queryLower = query.toLowerCase();
      const resultados = documentosComuns.filter(doc =>
        doc.toLowerCase().includes(queryLower)
      );

      // Se encontrou resultados, mostrar na lista
      if (resultados.length > 0) {
        // Adicionar cada resultado
        resultados.forEach(doc => {
          const item = document.createElement('div');
          item.className = 'p-3 hover:bg-blue-50 cursor-pointer flex items-center justify-between';
          item.innerHTML = `
            <span class="font-medium text-gray-800">${doc}</span>
            <i class="fas fa-plus text-gray-400"></i>
          `;

          // Evento de clique para adicionar o documento
          item.addEventListener('click', function() {
            adicionarDocumento(doc);
            searchInput.value = '';
            resultadosContainer.classList.add('hidden');
          });

          listaResultados.appendChild(item);
        });
      } else {
        // Nenhum resultado encontrado - adicionar mensagem
        const noResultsMsg = document.createElement('div');
        noResultsMsg.className = 'p-3 text-center text-gray-500 italic';
        noResultsMsg.textContent = 'Nenhum documento encontrado';
        listaResultados.appendChild(noResultsMsg);
      }

      // Sempre mostrar opção de criar novo com o texto atual
      textoNovoDocumento.textContent = query;
      opcaoNovoDocumento.style.display = 'block';
    });

    // Fechar resultados ao clicar fora
    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !resultadosContainer.contains(e.target)) {
        resultadosContainer.classList.add('hidden');
      }
    });

    // Permitir criar documento com Enter
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        const query = this.value.trim();
        if (query) {
          adicionarDocumento(query);
          this.value = '';
          resultadosContainer.classList.add('hidden');
          e.preventDefault();
        }
      }
    });
  }

  // Função para adicionar um novo documento
  function adicionarDocumento(nomeDocumento) {
    try {
      // Obter elementos
      const template = document.getElementById('documentoTemplate');
      const documentosContainer = document.getElementById('documentos-container');

      if (!template || !documentosContainer) {
        console.error('Template ou container de documentos não encontrado');
        return;
      }

      // Clonar o template
      const novoDocumento = template.content.cloneNode(true);

      // Preencher o nome do documento
      const inputNome = novoDocumento.querySelector('.nome-documento');
      if (inputNome) {
        inputNome.value = nomeDocumento;
      }

      // Configurar botão de remover
      const btnRemover = novoDocumento.querySelector('.remover-documento');
      if (btnRemover) {
        btnRemover.addEventListener('click', function() {
          this.closest('.documento-adicionado').remove();
        });
      }

      // Adicionar à lista de documentos
      documentosContainer.appendChild(novoDocumento);

      // Configurar eventos de status para o novo documento
      const statusSelect = novoDocumento.querySelector('.status-documento');
      if (statusSelect) {
        statusSelect.addEventListener('change', function() {
          toggleDocumentFields(this);
        });
      }

      // Rolar até o novo documento
      const ultimoDocumento = documentosContainer.lastElementChild;
      if (ultimoDocumento) {
        ultimoDocumento.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      console.log('Documento adicionado com sucesso:', nomeDocumento);

    } catch (error) {
      console.error('Erro ao adicionar documento:', error);
    }
  }

  // Função para mostrar/ocultar campos com base no status
  function toggleDocumentFields(selectElement) {
    try {
      const documentContainer = selectElement.closest('.documento-adicionado');
      const status = selectElement.value;

      // Ocultar todos os campos específicos
      const fieldGroups = documentContainer.querySelectorAll('.document-status-fields');
      fieldGroups.forEach(group => {
        group.classList.add('hidden');
      });

      // Mostrar os campos para o status selecionado
      if (status) {
        const targetFields = documentContainer.querySelector(`.${status}-fields`);
        if (targetFields) {
          targetFields.classList.remove('hidden');
        }
      }
    } catch (error) {
      console.error('Erro ao alternar campos de documento:', error);
    }
  }
</script>

