<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Ficha de Atendimento Previdenciário</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com?v=3.3.5"></script>

  <!-- Configuração do Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            whatsapp: '#25D366',
            'form-bg': '#f3f6fb',
            'filled-bg': '#f7f9ff'
          },
          gridTemplateColumns: {
            '24': 'repeat(24, minmax(0, 1fr))',
          }
        }
      }
    };
  </script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/search.css">
  <link rel="stylesheet" href="css/cadunico.css">
</head>
<body class="bg-white">
  <!-- Navbar fixa no topo -->
  <div class="fixed top-0 left-0 right-0 bg-white shadow-sm border-b z-50" style="scrollbar-gutter: stable;">
    <div class="max-w-[1440px] mx-auto px-4 py-2">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2 cursor-pointer" id="logo-container">
          <div class="bg-blue-600 text-white p-2 rounded-lg flex items-center justify-center shadow-sm">
            <span class="font-bold text-lg">FIAP</span>
          </div>
          <div class="flex flex-col">
            <span class="font-semibold text-gray-600 text-sm">Ficha Inteligente de</span>
            <span class="font-semibold text-gray-600 text-sm">Atendimento Previdenciário</span>
          </div>
        </div>

        <!-- Navegação centralizada -->
        <div class="flex-grow flex justify-center">
          <div class="nav-container main-nav" id="step-map">
            <a href="#personal" class="step-link" data-step="1" title="Dados Pessoais">
              <i class="fas fa-user"></i>
            </a>
            <a href="#social" class="step-link" data-step="2" title="Perfil Social">
              <i class="fas fa-users"></i>
            </a>
            <a href="#incapacity" class="step-link" data-step="3" title="Incapacidades">
              <i class="fas fa-heartbeat"></i>
            </a>
            <a href="#professional" class="step-link" data-step="4" title="Atividades Profissionais">
              <i class="fas fa-hands-helping"></i>
            </a>
            <a href="#documents" class="step-link" data-step="5" title="Documentos e Conclusão">
              <i class="fas fa-file-alt"></i>
            </a>
            <div class="nav-slider"></div>
          </div>
        </div>        <!-- Botões de ação no canto superior direito -->
        <div class="flex items-center gap-3">
          <!-- Indicador de status de conexão -->
          <div id="connection-status" class="flex items-center text-sm mr-2">
            <span id="online-indicator" class="w-2 h-2 rounded-full bg-green-500 mr-1"></span>
            <span id="online-text" class="text-xs text-gray-600">Online</span>
          </div>

          <!-- Ações essenciais -->
          <button type="button" class="navbar-action" title="Buscar formulário" id="btn-search">
            <i class="fas fa-search text-lg"></i>
          </button>
          <button type="button" class="navbar-action" title="Novo formulário" id="btn-new">
            <i class="fas fa-file-medical text-lg"></i>
          </button>
          <button type="button" class="navbar-action" title="Salvar formulário" id="btn-save">
            <i class="fas fa-save text-lg"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Conteúdo principal - onde os módulos serão carregados -->
  <div class="pt-16">
    <div class="max-w-[1440px] mx-auto p-4">
      <div id="app-content" class="content-wrapper">
        <!-- O conteúdo dos módulos será carregado aqui pelo router -->
      </div>
    </div>
  </div>

  <!-- Modal para buscar formulário por CPF -->
  <div id="searchFormModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-700">Buscar Formulário</h2>
        <button id="closeSearchModal" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>      <p class="text-gray-600 mb-4">Digite o CPF ou identificador do formulário que deseja carregar:</p>

      <div class="mb-4">
        <input type="text" id="searchFormCPF" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Ex: 123.456.789-00" oninput="FIAP.masks.cpf(this)">
      </div>

      <div class="flex justify-end space-x-2">
        <button id="cancelSearchForm" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700">
          Cancelar
        </button>
        <button id="searchFormButton" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">
          <i class="fas fa-search mr-1"></i> Buscar
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts do Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-analytics-compat.js"></script>

  <!-- Sistema de persistência simplificado e unificado -->
  <script src="js/storage.js"></script>

  <!-- Script de Estado - versão existente -->
  <script src="js/state.js"></script>

  <!-- Scripts da aplicação existente -->
  <script src="js/config.js"></script>
  <script src="js/cache.js"></script>
  <script src="js/mask.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/firebase.js"></script>
  <script src="js/tailwind.js"></script>
  <script src="js/forms.js"></script>
  <script src="js/clearSections.js"></script>
  <script src="js/address.js"></script>
  <script src="js/search.js"></script>
  <script src="js/cid.js"></script>
  <script src="js/fix-documents.js"></script>
  <script src="js/document-functions.js"></script>
  <script src="js/state-fix.js"></script>
  <script src="js/router.js"></script>

  <!-- Novo sistema de persistência complementar (carregado depois) -->
  <!-- <script type="module" src="js/app.js"></script> -->

  <script>
    // Inicialização da aplicação
    document.addEventListener('DOMContentLoaded', function() {
      // Inicia o router
      initRouter();

      // Inicializar o sistema de destaque de campos
      if (typeof setupFieldHighlighting === 'function') {
        setupFieldHighlighting();
      }

      // Configuração dos botões da navbar
      document.getElementById('btn-new').addEventListener('click', newForm);
      document.getElementById('btn-save').addEventListener('click', saveForm);
      document.getElementById('btn-search').addEventListener('click', openSearchFormModal);

      // Adicionar evento de clique no logo para ir para a home
      document.getElementById('logo-container').addEventListener('click', function() {
        navigateTo('home');
      });

      // Configuração do modal de busca
      const searchModal = document.getElementById('searchFormModal');
      const closeModalButton = document.getElementById('closeSearchModal');
      const cancelButton = document.getElementById('cancelSearchForm');
      const searchButton = document.getElementById('searchFormButton');
      const searchInput = document.getElementById('searchFormCPF');

      // Configurar eventos do modal
      closeModalButton.addEventListener('click', closeSearchFormModal);
      cancelButton.addEventListener('click', closeSearchFormModal);
      searchButton.addEventListener('click', () => {
        const key = searchInput.value.trim();
        if (key) {
          closeSearchFormModal();
          loadFormByKey(key);
        } else {
          showError('Por favor, informe um CPF ou identificador válido');
        }
      });

      // Permitir buscar ao pressionar Enter
      searchInput.addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
          searchButton.click();
        }
      });

      // Fechar o modal ao clicar fora dele
      window.addEventListener('click', function(event) {
        if (event.target === searchModal) {
          closeSearchFormModal();
        }
      });

      // Configurar o indicador de status de conexão
      setupConnectionStatus();

      // Verificar compatibilidade do navegador
      checkBrowserCompatibility();
    });

    // Função para configurar o indicador de status de conexão
    function setupConnectionStatus() {
      const indicator = document.getElementById('online-indicator');
      const text = document.getElementById('online-text');

      function updateConnectionStatus() {
        if (navigator.onLine) {
          indicator.classList.remove('bg-red-500');
          indicator.classList.add('bg-green-500');
          text.textContent = 'Online';
          text.classList.remove('text-red-600');
          text.classList.add('text-gray-600');
        } else {
          indicator.classList.remove('bg-green-500');
          indicator.classList.add('bg-red-500');
          text.textContent = 'Offline';
          text.classList.remove('text-gray-600');
          text.classList.add('text-red-600');
        }
      }

      // Atualizar status inicial
      updateConnectionStatus();

      // Adicionar listeners para eventos de mudança de conexão
      window.addEventListener('online', updateConnectionStatus);
      window.addEventListener('offline', updateConnectionStatus);
    }

    // Função para verificar compatibilidade do navegador
    function checkBrowserCompatibility() {
      // Verificar suporte a localStorage
      let storageAvailable = false;
      try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        storageAvailable = true;
      } catch (e) {
        console.error('localStorage não disponível:', e);
      }

      if (!storageAvailable) {
        const warningDiv = document.createElement('div');
        warningDiv.className = 'fixed bottom-4 left-4 right-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded shadow-lg z-50';
        warningDiv.innerHTML = `
          <div class="flex items-center">
            <div class="text-yellow-500 rounded-full p-1">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <span class="ml-2">Seu navegador não suporta armazenamento local. A persistência de dados pode não funcionar corretamente.</span>
          </div>
        `;
        document.body.appendChild(warningDiv);
      }
    }

    // Funções para manipulação do modal de busca
    function openSearchFormModal() {
      const modal = document.getElementById('searchFormModal');
      modal.classList.remove('hidden');
      document.getElementById('searchFormCPF').focus();
    }

    function closeSearchFormModal() {
      const modal = document.getElementById('searchFormModal');
      modal.classList.add('hidden');
    }
  </script>
</body>
</html>
